{%- from 'components/button/macro.html' import tnaButton -%}
{%- from 'components/card/macro.html' import tnaCard -%}
{%- from 'components/picture/macro.html' import tnaPicture -%}
{%- from 'components/featured-records/macro.html' import tnaFeaturedRecords -%}

{% macro articleBlocks(blocks, merge_dict_if) %}
  {%- for block in blocks %}
  <h2 class="etna-article__section-button-header tna-heading-l" hidden>
    <button class="etna-article__section-button">
      <span class="etna-article__section-button-label">{{ block.value.heading }}</span>
      <svg class="etna-article__section-button-icon etna-article__section-button-icon--down" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" /></svg>
      <svg class="etna-article__section-button-icon etna-article__section-button-icon--up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z" /></svg>
    </button>
  </h2>

  <section class="etna-article__section">
    <h2 class="tna-heading-l tna-!--padding-top-s etna-article__section-heading" id="{{ block.value.heading | slugify }}">{{ block.value.heading }}</h2>
    {%- for content_item in block.value.content %}
      {%- if content_item.type == 'paragraph' %}
      {{ content_item.value.text | tna_html | safe }}

      {% elif content_item.type == 'sub_heading' %}
      <h3 class="tna-heading-m">{{ content_item.value.heading }}</h3>

      {% elif content_item.type == 'table' %}
      <h3 class="tna-heading-m">{{ content_item.value.title }}</h3>
      {{ content_item.value.table | tna_table }}

      {%- elif content_item.type == 'image' %}
      {% set picture_information = [] %}
      {%- if content_item.value.image.transcript %}
      {% set picture_information = picture_information + [{
        'id': 'transcript-' + content_item.id,
        'title': content_item.value.image.transcript.heading or 'Transcript',
        'body': content_item.value.image.transcript.text | tna_html
      }] %}
      {%- endif %}
      {%- if content_item.value.image.translation %}
      {% set picture_information = picture_information + [{
        'id': 'translation-' + content_item.id,
        'title': content_item.value.image.translation.heading or 'Translation',
        'body': content_item.value.image.translation.text | tna_html
      }] %}
      {%- endif %}
      {{ tnaPicture({
        'src': content_item.value.image.jpeg.full_url,
        'alt': content_item.value.image.jpeg.alt_text,
        'width': content_item.value.image.jpeg.width,
        'height': content_item.value.image.jpeg.height,
        'sources': [
          {
            'src': content_item.value.image.webp.full_url,
            'type': 'image/webp'
          }
        ],
        'caption': content_item.value.caption,
        'information': picture_information
      }) }}

      {%- elif content_item.type == 'quote' %}
      <blockquote class="tna-blockquote">
        <div class="tna-blockquote__quote">
          {{ content_item.value.quote | safe }}
        </div>
        {% if content_item.value.attribution %}
        <p class="tna-blockquote__citation">{{ content_item.value.attribution }}</p>
        {% endif %}
      </blockquote>

      {%- elif content_item.type == 'promoted_list' %}
      <aside class="etna-space-above">
        <ul class="etna-block-list">
          {%- for item in content_item.value.promoted_items %}
          <li>
            {% set supertitle = '' %}
            {% set title = item.title %}
            {% if 'blog.nationalarchives.gov.uk' in item.url %}
              {% set supertitle = 'Blog' %}
              {% set title = title.removeprefix('Blog: ') %}
            {% elif 'www.nationalarchives.gov.uk/help-with-your-research/research-guides' in item.url %}
              {% set supertitle = 'Research guide' %}
              {% set title = title.removeprefix('Research guide: ').removeprefix('Research Guide: ') %}
            {% elif 'www.nationalarchives.gov.uk/education/resources' in item.url %}
              {% if title.startswith('Teaching resource') %}
                {% set supertitle = 'Teaching resource' %}
                {% set title = title.removeprefix('Teaching resource: ').removeprefix('Teaching Resource: ') %}
              {% elif title.startswith('Classroom resource') %}
                {% set supertitle = 'Classroom resource' %}
                {% set title = title.removeprefix('Classroom resource: ').removeprefix('Classroom Resource: ') %}
              {% endif %}
            {% elif 'media.nationalarchives.gov.uk' in item.url %}
              {% set supertitle = 'Podcast' %}
              {% set title = title.removeprefix('Podcast: ') %}
            {% elif 'youtube.com' in item.url %}
              {% set supertitle = 'Film' %}
              {% set title = title.removeprefix('Film: ') %}
            {% endif %}
            {% if supertitle %}
            <hgroup class="tna-hgroup-s">
              <p class="tna-hgroup__supertitle">{{ supertitle }}</p>
              <h3 class="tna-hgroup__title">
                <a href="{{ item.url }}">{{ title }}</a>
              </h3>
            </hgroup>
            {% else %}
            <h3 class="tna-heading-s">
              <a href="{{ item.url }}">{{ title }}</a>
            </h3>
            {% endif %}
            {{ item.description | safe }}
          </li>
          {%- endfor %}
        </ul>
      </aside>

      {%- elif content_item.type == 'promoted_item' %}
      <aside class="etna-space-above">
      {% set card_content = {
        'title': content_item.value.title,
        'headingLevel': 3,
        'headingSize': 'm',
        'body': content_item.value.description,
        'actions': [
          {
            'text': content_item.value.cta_label,
            'href': content_item.value.url,
            'title': content_item.value.cta_label + ' (opens a new tab)' if content_item.value.target_blank else None,
            'attributes': {
              'target': '_blank' if content_item.value.target_blank
            }
          }
        ],
        'style': 'tint',
        'htmlElement': 'article'
      } %}
      {% set card_content = merge_dict_if(card_content, {
        'horizontal': True,
        'imageSrc': content_item.value.image.image.jpeg.full_url,
        'imageAlt': content_item.value.image.image.alt_text,
        'imageWidth': content_item.value.image.image.jpeg.width,
        'imageHeight': content_item.value.image.image.jpeg.height,
        'classes': 'tna-card__promoted-item'
      }, content_item.value.image.image) %}
      {{ tnaCard(card_content) }}
      </aside>

      {%- elif content_item.type == 'record_links' %}
      {% set items = [] %}
      {%- for i in content_item.value['items'] %}
        {# {% with parent = i.record_data.hierarchy | last %} #}
        {# TODO: Collection #}
        {%- if i.thumbnail_image %}
        {{ items.append({
          'imageSrc': i.thumbnail_image.jpeg.full_url,
          'width': i.thumbnail_image.jpeg.width,
          'height': i.thumbnail_image.jpeg.height,
          'collection': 'parent.identifier',
          'title': i.descriptive_title,
          'href': url_for('catalogue.details', id=i.record),
          'date': i.record_dates
        }) or "" }}
        {%- else %}
        {{ items.append({
          'collection': 'parent.identifier',
          'title': i.descriptive_title,
          'href': url_for('catalogue.details', id=i.record),
          'date': i.record_dates
        }) or "" }}
        {%- endif %}
        {# {% endwith %} #}
      {%- endfor %}
      {{ tnaFeaturedRecords({
        'items': items
      }) }}

      {%- elif content_item.type == 'featured_record_article' %}
      {%- if content_item.value.page %}
      {# TODO: Date #}
      <aside class="etna-space-above">
      {{ tnaCard({
        'supertitle': content_item.value.page.type_label,
        'title': content_item.value.page.title,
        'headingLevel': 3,
        'headingSize': 's',
        'href': content_item.value.page.url,
        'meta': [
          {
            'title': 'Date',
            'text': 'content_item.value.date_text',
            'icon': 'calendar'
          }
        ],
        'label': 'New' if content_item.value.page.is_newly_published else None,
        'text': content_item.value.page.teaser_text,
        'imageSrc': content_item.value.page.teaser_image.jpeg.full_url,
        'imageAlt': content_item.value.page.teaser_image.alt,
        'imageWidth': content_item.value.page.teaser_image.jpeg.width,
        'imageHeight': content_item.value.page.teaser_image.jpeg.height,
        'lazyImage': True,
        'style': 'contrast',
        'htmlElement': 'article',
        'horizontal': True
      }) }}
      {%- endif %}
      </aside>

      {%- elif content_item.type == 'media' %}
      <aside class="etna-space-above" itemprop="audio" itemscope itemtype="https://schema.org/AudioObject">
        <div class="tna-aside etna-background-masked-image">
          <img src="{{ content_item.value.background_image.jpeg.full_url }}" class="etna-background-masked-image__image">
          <hgroup class="tna-hgroup-l">
            <p class="tna-hgroup__supertitle">Listen</p>
            <h3 class="tna-hgroup__title" itemprop="name">
              {{ content_item.value.title }}
            </h3>
          </hgroup>
          <div itemprop="description" class="tna-!--margin-top-s">
            {{ content_item.value.media.description | safe }}
          </div>
          <audio class="etna-audio" controls="" aria-label="Transcript provided below">
            <source itemprop="contentUrl" src="{{ content_item.value.media.full_url }}" type="{{ content_item.value.media.mime }}" itemprop="contentUrl">
            <p>Your browser doesn't support HTML5 audio. <a href="{{ content_item.value.media.full_url }}">Download the audio file</a>.</p>
          </audio>
          <meta itemprop="encodingFormat" content="{{ content_item.value.media.mime }}">
        </div>
        <div class="tna-aside tna-background-contrast tna-!--no-margin-top">
          <h4 class="tna-heading-m tna-!--padding-bottom-s">Transcript</h4>
          <div itemprop="transcript">
            {{ content_item.value.media.transcript | safe }}
          </div>
        </div>
      </aside>

      {%- else %}
      <h1 class="tna-heading-xl">======= {{ content_item.type }} =======</h1>
      {%- endif %}
    {%- endfor %}
  </section>
  {%- endfor %}
{% endmacro %}