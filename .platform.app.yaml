name: app

type: "python:3.12"

variables:
  env:
    ENVIRONMENT: production
    POETRY_VIRTUALENVS_IN_PROJECT: true
    POETRY_VIRTUALENVS_CREATE: true

disk: 2048

hooks:
  build: |
    rm -fR .local .venv
    python3 -m venv .venv
    source .venv/bin/activate
    curl -sSL https://install.python-poetry.org | python3 - --version 1.6.1
    export PATH="/app/.local/bin:$PATH"
    poetry install --sync --no-root
    poetry add gunicorn@21.2.0
    npm install
    npm run build
    mkdir app/static/assets
    cp -r node_modules/@nationalarchives/frontend/nationalarchives/assets/* app/static/assets

web:
  upstream:
    socket_family: unix
  commands:
    start: "poetry run gunicorn etna:app --bind unix:$SOCKET --capture-output"
  locations:
    "/":
      root: ""
      passthru: true
      allow: false
    "/static":
      headers:
        Access-Control-Allow-Origin: "*"
      root: static
      expires: 1y
      allow: true

mounts:
  tmp:
    source: local
    source_path: tmp

crons:
  renewcert:
    spec: "0 4 1,15 * *"
    cmd: |
      if [ "$PLATFORM_BRANCH" = main ]; then
        platform redeploy --yes --no-wait
      fi
